services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: backend-shortener
    ports:
      - "${PORT:-3000}:3000"
    environment:
      PORT: 3000
      CASSANDRA_ADRESS: cassandra
      CASSANDRA_LOCAL_DATA_CENTER: datacenter1
      CASSANDRA_KEYSPACE: ${CASSANDRA_KEYSPACE:-shortener}
      SALT_BASE_62: ${SALT_BASE_62:-defaultsalt}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:5153,http://localhost:5173,http://localhost:4200,http://127.0.0.1:5153,http://127.0.0.1:5173,http://host.docker.internal:5153,http://host.docker.internal:5173}
      CORS_CREDENTIALS: ${CORS_CREDENTIALS:-true}
      CORS_METHODS: ${CORS_METHODS:-GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS:-Content-Type,Authorization,x-api-key,X-Api-Key}
      CORS_EXPOSED_HEADERS: ${CORS_EXPOSED_HEADERS:-}
      CORS_MAX_AGE: ${CORS_MAX_AGE:-3600}
      API_KEY: ${API_KEY:-calamiao}
    depends_on:
      cassandra:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - shortener-network

  cassandra:
    image: cassandra:5
    container_name: shortener-cassandra
    ports:
      - "9042:9042"
    volumes:
      - cassandra-data:/var/lib/cassandra
    environment:
      CASSANDRA_CLUSTER_NAME: shortener-cluster
      CASSANDRA_DC: datacenter1
      CASSANDRA_RACK: rack1
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe cluster'"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    networks:
      - shortener-network

  cassandra-init:
    image: cassandra:5
    container_name: shortener-cassandra-init
    depends_on:
      cassandra:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        cqlsh cassandra -e "CREATE KEYSPACE IF NOT EXISTS shortener WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 1};"
        cqlsh cassandra -e "CREATE TABLE IF NOT EXISTS shortener.short_urls (short_code text PRIMARY KEY, original_url text, created_at timestamp);"
    restart: "no"
    networks:
      - shortener-network

  redis:
    image: redis:7-alpine
    container_name: shortener-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - shortener-network

volumes:
  cassandra-data:
  redis-data:

networks:
  shortener-network:
    driver: bridge
